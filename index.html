<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>無障月途App概念展示</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a modern app feel */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight */
        }

        #app-container {
            max-width: 400px;
            height: 800px;
            margin: 2rem auto;
            border: 8px solid #4A5568;
            border-radius: 2rem;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            background-color: #F3F4F6;
            /* Disable text selection on long press for mobile */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }

        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out;
        }
        .screen-content {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        .screen.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* --- Splash Screen Styles --- */
        #splash-screen {
            background-color: #FFFFFF;
            z-index: 100;
            cursor: pointer;
        }
        #splash-screen h1 {
            animation: zoomIn 0.8s 0.2s ease-out forwards;
            opacity: 0;
        }
        #splash-screen.fade-out {
            animation: fadeOut 0.5s ease-in forwards;
        }
        @keyframes zoomIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        /* --- Onboarding Styles --- */
        #onboarding-screen {
            background-color: #F3F4F6;
            z-index: 50;
        }
        .onboarding-slide-container {
            display: flex;
            width: 400%; /* 4 slides */
            height: 100%;
            transition: transform 0.4s ease-in-out;
        }
        .onboarding-slide {
            box-sizing: border-box;
            width: calc(100% / 4);
            flex-shrink: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 2rem;
            text-align: center;
        }
        .onboarding-image-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .onboarding-content {
            background-color: white;
            width: 100%;
            padding: 2rem 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .progress-dots {
            display: flex;
            gap: 8px;
            margin-bottom: 1.5rem;
        }
        .dot {
            width: 10px;
            height: 10px;
            background-color: #D1D5DB;
            border-radius: 50%;
            transition: all 0.3s;
        }
        .dot.active {
            background-color: #8B5CF6;
            transform: scale(1.2);
        }
        
        .card {
            background-color: #FFFFFF;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        #bottom-nav {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 5rem;
            background-color: #FFFFFF;
            border-top: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        #bottom-nav.visible {
            transform: translateY(0);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #9CA3AF;
            cursor: pointer;
            flex: 1;
            padding: 0.5rem 0;
        }
        .nav-item.active {
            color: #8B5CF6;
        }
        .nav-item svg { width: 28px; height: 28px; }
        .nav-item span { font-size: 0.75rem; margin-top: 0.25rem; }
        
        #voice-prompt-visual {
            background-color: #2d3748;
            color: white;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        #voice-prompt-visual.visible {
            max-height: 100px;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        
        #camera-view { width: 100%; height: 100%; object-fit: cover; }
        .analysis-result { border-left-width: 4px; }
        
        /* --- Calendar Styles --- */
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-header { text-align: center; font-weight: 600; color: #6B7280; font-size: 0.875rem; }
        .calendar-day {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
        }
        .calendar-day.menstruation { background-color: #FBCFE8; color: #9D2463; }
        .calendar-day.ovulation { background-color: #C4B5FD; color: #5B21B6; border: 2px solid #8B5CF6; }
        .calendar-day.fertile { background-color: #A5F3FC; color: #0E7490; }
        .calendar-day.safe { background-color: #D1FAE5; color: #065F46; }
        .calendar-day.today { border: 2px solid #8B5CF6; }
        .calendar-day.empty { background: none; cursor: default; }

        /* Typing indicator */
        .typing-indicator {
            position: absolute;
            bottom: 6rem;
            right: 1.5rem;
            background-color: #8B5CF6; /* Purple color */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none; /* So it doesn't block clicks */
            display: flex;
            align-items: center;
        }
        .typing-indicator.visible {
            opacity: 1;
        }
        
        /* AI Loading Indicator - iOS compatible */
        .dot-flashing-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dot-flashing {
            width: 6px;
            height: 6px;
            margin: 0 4px;
            background-color: #ffffff;
            border-radius: 50%;
            animation: dotFlashing 1s infinite linear alternate;
        }
        .dot-flashing:nth-child(1) { animation-delay: 0s; }
        .dot-flashing:nth-child(2) { animation-delay: 0.2s; }
        .dot-flashing:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dotFlashing {
            0% {
                background-color: #ffffff;
                transform: scale(1);
            }
            50%,
            100% {
                background-color: #d9d3ff;
                transform: scale(0.7);
            }
        }
    </style>
</head>
<body class="bg-gray-200">

    <div id="app-container" class="flex flex-col">
        <div id="splash-screen" class="screen active items-center justify-center">
            <h1 class="text-6xl font-bold text-purple-600 text-center leading-tight">無障<br>月途</h1>
        </div>

        <!-- App Header -->
        <header id="app-header" class="bg-white p-4 flex items-center justify-center h-20 shadow-sm z-10 opacity-0 transition-opacity duration-300 flex-shrink-0">
            <h1 id="screen-title" class="text-2xl font-bold text-purple-600">無障月途</h1>
        </header>
        
        <!-- Voice Prompt Visual Bar -->
        <div id="voice-prompt-visual" class="flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414z" clip-rule="evenodd" /><path d="M16.293 4.343a1 1 0 011.414 0A6.972 6.972 0 0119 10a6.972 6.972 0 01-1.293 4.243 1 1 0 11-1.414-1.414A4.971 4.971 0 0017 10c0-1.379-.558-2.621-1.464-3.536a1 1 0 010-1.414z" /></svg>
            <p id="voice-prompt-text"></p>
        </div>
        
        <!-- Main content area -->
        <main class="flex-grow relative">
            
            <!-- Onboarding Screen -->
            <div id="onboarding-screen" class="screen" style="z-index: 50; background-color: #F3F4F6;">
                <div class="onboarding-slide-container">
                    <!-- Slide 1 -->
                    <div class="onboarding-slide">
                        <div class="onboarding-image-container">
                             <svg class="w-48 h-48 text-purple-300" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1.2-9.1c0-.66.54-1.2 1.2-1.2.66 0 1.2.54 1.2 1.2l-.01 6.2c0 .66-.53 1.2-1.19 1.2s-1.2-.54-1.2-1.2V4.9zm6.5 6.1c0 3.03-2.47 5.5-5.5 5.5S6.3 14.03 6.3 11H4.1c0 3.53 2.61 6.43 6 6.92V21h3.8v-3.08c3.39-.49 6-3.39 6-6.92h-2.2z"></path></svg>
                        </div>
                        <div class="onboarding-content">
                             <div class="progress-dots justify-center"></div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">歡迎使用</h2>
                            <p class="text-gray-600 mb-6">長按屏幕兩秒，就可以隨時用廣東話發出指令。</p>
                            <button class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg">下一步</button>
                        </div>
                    </div>
                    <!-- Slide 2 -->
                    <div class="onboarding-slide">
                        <div class="onboarding-image-container">
                            <svg class="w-48 h-48 text-purple-300" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"></path></svg>
                        </div>
                        <div class="onboarding-content">
                            <div class="progress-dots justify-center"></div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">輕鬆記錄週期</h2>
                            <p class="text-gray-600 mb-6">想睇下自己嘅週期？隨時講「週期」，就可以打開您嘅個人日曆。</p>
                            <button class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg">下一步</button>
                        </div>
                    </div>
                    <!-- Slide 3 -->
                    <div class="onboarding-slide">
                             <div class="onboarding-image-container">
                             <svg class="w-48 h-48 text-purple-300" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"></path></svg>
                        </div>
                        <div class="onboarding-content">
                             <div class="progress-dots justify-center"></div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">一掃即知健康</h2>
                            <p class="text-gray-600 mb-6">想分析健康狀況？請講「分析」或「掃描」，然後按照語音提示操作。</p>
                            <button class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg">下一步</button>
                        </div>
                    </div>
                    <!-- Slide 4 -->
                    <div class="onboarding-slide">
                        <div class="onboarding-image-container">
                            <svg class="w-48 h-48 text-purple-300" viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.9 2 1.99 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                        </div>
                        <div class="onboarding-content">
                             <div class="progress-dots justify-center"></div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">購物與學習</h2>
                            <p class="text-gray-600 mb-6">無論係想買嘢定係學新知識，只要講出「購買」或「學習」，我就會幫到您。</p>
                            <button class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg">完成</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Permission Screen -->
            <div id="permission-screen" class="screen items-center justify-center p-8">
                <div class="bg-white p-8 rounded-lg text-center max-w-sm shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">權限請求</h2>
                    <p class="text-gray-600 mb-6">為咗提供完整嘅語音操控同健康掃描功能，我哋需要您授權使用裝置嘅麥克風同相機。</p>
                    <button class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg" onclick="requestPermissions(true)">允許權限</button>
                </div>
            </div>

            <!-- Main App Screens -->
            <div id="purchase-screen" class="screen"></div>
            <div id="analysis-screen" class="screen"></div>
            <div id="tracker-screen" class="screen"></div>
            <div id="education-screen" class="screen"></div>

        </main>
        
        <!-- Bottom Navigation Bar -->
        <footer id="bottom-nav" class="flex-shrink-0">
            <button onclick="navigate('purchase-screen', this)" class="nav-item active">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                <span>購買</span>
            </button>
            <button onclick="navigate('analysis-screen', this)" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                </svg>
                <span>分析</span>
            </button>
            <button onclick="navigate('tracker-screen', this)" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M-4.5 12h22.5" /></svg>
                <span>週期</span>
            </button>
            <button onclick="navigate('education-screen', this)" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                <span>學習</span>
            </button>
        </footer>
        <div id="typing-indicator" class="typing-indicator" aria-hidden="true">
            <div class="dot-flashing-container">
                <div class="dot-flashing"></div>
                <div class="dot-flashing"></div>
                <div class="dot-flashing"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Global App Variables and Functions ---
        const appContainer = document.getElementById('app-container');
        const screens = document.querySelectorAll('.screen');
        const navItems = document.querySelectorAll('.nav-item');
        const voicePromptVisual = document.getElementById('voice-prompt-visual');
        const voicePromptText = document.getElementById('voice-prompt-text');
        const typingIndicator = document.getElementById('typing-indicator');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        let voiceTimeout;
        let stream;
        let isListening = false;
        let recognition;
        let isAudioUnlocked = false;
        
        // Check if Speech Recognition is supported
        let speechNotSupported = !SpeechRecognition;

        // Mapping of screen IDs to their chat input/content elements
        const chatScreenMap = {
            'purchase-screen': { inputId: 'purchase-input', chatContentId: 'purchase-chat-content' },
            'education-screen': { inputId: 'education-input', chatContentId: 'education-chat-content' }
        };

        // --- Core App Functions ---

        // Modified speak function to cancel ongoing speech and handle callbacks
        function speak({ visual, spoken, onEndCallback }) {
            // Ensure speech synthesis is available
            if (!('speechSynthesis' in window)) {
                console.warn("Speech synthesis not supported.");
                if (onEndCallback && typeof onEndCallback === 'function') onEndCallback();
                return;
            }
            
            // Immediately cancel any ongoing speech
            window.speechSynthesis.cancel();
            
            // Show visual prompt
            const textToSpeak = spoken || visual;
            voicePromptText.textContent = visual;
            voicePromptVisual.classList.add('visible');
            if (voiceTimeout) clearTimeout(voiceTimeout);
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'zh-HK';
            
            // Find a Cantonese voice if available
            const cantoneseVoice = window.speechSynthesis.getVoices().find(voice => voice.lang === 'zh-HK');
            if (cantoneseVoice) {
                utterance.voice = cantoneseVoice;
            }
            utterance.rate = 1.0;
            
            utterance.onend = () => {
                voicePromptVisual.classList.remove('visible');
                if (onEndCallback && typeof onEndCallback === 'function') {
                    onEndCallback();
                }
            };
            
            window.speechSynthesis.speak(utterance);
        }
        
        // Modified function to start voice command with "Listening" prompt
        function startVoiceCommand() {
            if (speechNotSupported) {
                 speak({ visual: "對唔住，您嘅瀏覽器唔支援語音識別功能。", spoken: "對唔住，您嘅瀏覽器唔支援語音識別功能。" });
                 return;
            }

            if (isListening) return;
            if (recognition) {
                try {
                    speak({ 
                        visual: '聆聽中...', 
                        spoken: '聆聽中', 
                        onEndCallback: () => {
                            // Ensure recognition starts after the "聆聽中" audio ends
                            setTimeout(() => {
                                if (recognition && !isListening) {
                                    recognition.start();
                                }
                            }, 100);
                        }
                    });
                } catch(e) {
                    console.error("Recognition start error:", e);
                    isListening = false;
                    if (e.name === 'NotAllowedError' || e.name === 'SecurityError') {
                        speak({ visual: "請先授權麥克風權限", spoken: "請先授權麥克風權限" });
                    } else {
                        speak({ visual: "語音功能目前無法使用", spoken: "語音功能目前無法使用" });
                    }
                }
            } else {
                speak({ visual: "對唔住，您嘅瀏覽器唔支援語音識別功能。", spoken: "對唔住，您嘅瀏覽器唔支援語音識別功能。" });
            }
        }
        
        // --- Interaction Logic ---
        let longPressTimer;

        // Long Press for Voice Commands
        const startLongPress = (e) => {
            if (e.target.closest('button, input')) return;
            if (isListening) return;
            longPressTimer = setTimeout(() => {
                startVoiceCommand();
            }, 2000); // 2 seconds
        };

        const cancelLongPress = () => {
            clearTimeout(longPressTimer);
        };

        appContainer.addEventListener('mousedown', startLongPress);
        appContainer.addEventListener('mouseup', cancelLongPress);
        appContainer.addEventListener('mouseleave', cancelLongPress);
        appContainer.addEventListener('touchstart', startLongPress, { passive: true });
        appContainer.addEventListener('touchend', cancelLongPress);
        appContainer.addEventListener('touchmove', cancelLongPress);

        // Tap Logic
        let tapCount = 0;
        let tapTimer;

        appContainer.addEventListener('click', (e) => {
            // Prevent tap logic from firing on buttons, inputs, or other interactive elements.
            if (e.target.closest('button, input, .nav-item, .onboarding-content')) {
                return;
            }

            tapCount++;
            clearTimeout(tapTimer); // Clear previous timer

            tapTimer = setTimeout(() => {
                if (tapCount === 1) {
                    // Single tap action
                    handleSingleTap();
                } else if (tapCount >= 2) {
                    // Double tap action
                    handleDoubleTap();
                }
                tapCount = 0; // Reset tap count after action
            }, 300); // 300ms window for double tap
        });

        function handleSingleTap() {
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) return;

            if (activeScreen.id === 'permission-screen') {
                requestPermissions(true); // Grant
            } else if (activeScreen.id === 'analysis-screen') {
                const cameraView = document.getElementById('scan-camera-view');
                const resultsView = document.getElementById('scan-results-view');
                if ((cameraView && !cameraView.classList.contains('hidden')) || (resultsView && !resultsView.classList.contains('hidden'))) {
                    resetScanView();
                }
            }
        }

        function handleDoubleTap() {
            const activeScreen = document.querySelector('.screen.active');
            if (!activeScreen) return;

            if (activeScreen.id === 'permission-screen') {
                requestPermissions(false); // Deny
            } else if (activeScreen.id === 'analysis-screen') {
                const cameraView = document.getElementById('scan-camera-view');
                const resultsView = document.getElementById('scan-results-view');

                if (cameraView && !cameraView.classList.contains('hidden')) {
                    startScan();
                } else if (resultsView && !resultsView.classList.contains('hidden')) {
                    rescanFromResults();
                } else {
                    startScanProcess();
                }
            }
        }
        
        if (!speechNotSupported) {
             recognition = new SpeechRecognition();
             recognition.continuous = false;
             recognition.lang = 'zh-HK';
             recognition.interimResults = false;
             recognition.maxAlternatives = 1;
        
             recognition.onstart = () => { isListening = true; };
             recognition.onend = () => { isListening = false; };
             
             recognition.onresult = (event) => {
                 const command = event.results[0][0].transcript.trim().toLowerCase().replace(/[.,。]/g, '');
                 const originalTranscript = event.results[0][0].transcript;
                 const activeScreenId = document.querySelector('.screen.active').id;
                 
                 const navCommands = {
                     '購買': 'purchase-screen', '購物': 'purchase-screen', '買嘢': 'purchase-screen',
                     '分析': 'analysis-screen', '健康': 'analysis-screen', '掃描': 'analysis-screen', '素描': 'analysis-screen',
                     '週期': 'tracker-screen', '月經': 'tracker-screen',
                     '學習': 'education-screen', '學嘢': 'education-screen', '教材': 'education-screen'
                 };
                 
                 if (activeScreenId === 'tracker-screen' && (command.includes('繼續') || command.includes('go on'))) {
                      speak({ visual: "為您詳細說明...", spoken: "您嘅經期預計喺9月9號到12號，排卵日大約喺8月26號。" });
                      return;
                 }
                 
                 if (activeScreenId === 'analysis-screen' && (command.includes('需要') || command.includes('好') || command.includes('yes'))) {
                     readHistory();
                     return;
                 }
                 
                 const isNavCommand = Object.keys(navCommands).some(key => command.includes(key));
                 if (isNavCommand) {
                     let targetScreen = Object.values(navCommands).find(screen => command.includes(screen));
                     if (!targetScreen) {
                        for (const keyword in navCommands) {
                            if (command.includes(keyword)) {
                                targetScreen = navCommands[keyword];
                                break;
                            }
                        }
                     }
                     
                     if (targetScreen) {
                         const targetElement = document.querySelector(`button[onclick*="${targetScreen}"]`);
                         if (targetElement) {
                             navigate(targetScreen, targetElement);
                         }
                     }
                     return;
                 }
                 
                 if (chatScreenMap[activeScreenId]) {
                     handleChatInput(originalTranscript, activeScreenId);
                 } else {
                     speak({ visual: `對唔住，聽唔明指令「${command}」`, spoken: `對唔住，聽唔明指令「${command}」` });
                 }
             };

             recognition.onerror = (event) => {
                 isListening = false;
                 if (event.error !== 'no-speech') {
                     console.error("Recognition error:", event.error);
                 }
             };
        }


        // Updated navigate function with new voice prompts and logic
        function navigate(screenId, clickedElement) {
            if (screenId !== 'analysis-screen' && stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            navItems.forEach(item => item.classList.remove('active'));
            clickedElement.classList.add('active');
            
            const announcements = {
                'purchase-screen': { visual: '你現在在購買頁', spoken: '你現在在購買頁，長按兩秒即可查詢購買資料' }, 
                'analysis-screen': { visual: '你現在在分析頁', spoken: '你現在在分析頁，需要提供歷史掃描紀錄嗎，如需要請說，需要，如不需要請忽略。你也可以按兩下屏幕開始準備掃描' },
                'tracker-screen': { visual: '你現在在週期頁', spoken: '你現在在週期頁，距離下次經期預計仲有15日。如需更加詳細，請講，繼續。' },
                'education-screen': { visual: '你現在在學習頁', spoken: '你現在在學習頁，長按兩秒即可詢問任何問題' }
            };
            const announcement = announcements[screenId];
            if(announcement) {
                speak({ 
                    visual: announcement.visual, 
                    spoken: announcement.spoken, 
                    onEndCallback: () => {
                        if (!speechNotSupported) {
                             if (screenId === 'analysis-screen' || screenId === 'tracker-screen' || screenId === 'onboarding-screen' || screenId === 'permission-screen') {
                                 setTimeout(startVoiceCommand, 500);
                             }
                        }
                    }
                });
            }
        }
        
        function checkPermissionsAndStart() {
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'microphone' }).then(micPermission => {
                    navigator.permissions.query({ name: 'camera' }).then(cameraPermission => {
                        if (micPermission.state === 'granted' && cameraPermission.state === 'granted') {
                            initializeApp(true);
                        } else {
                            document.getElementById('onboarding-screen').classList.add('active');
                            updateOnboardingView();
                        }
                    }).catch(e => {
                        console.error("Camera permission query failed:", e);
                        document.getElementById('onboarding-screen').classList.add('active');
                        updateOnboardingView();
                    });
                }).catch(e => {
                    console.error("Microphone permission query failed:", e);
                    document.getElementById('onboarding-screen').classList.add('active');
                    updateOnboardingView();
                });
            } else {
                document.getElementById('onboarding-screen').classList.add('active');
                updateOnboardingView();
            }
        }

        async function requestPermissions(grant) {
            if (grant) {
                try {
                    const mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    mediaStream.getTracks().forEach(track => track.stop());
                    initializeApp(false);
                } catch (err) {
                    console.error("Permission denied:", err);
                    handlePermissionDenial();
                }
            } else {
                handlePermissionDenial();
            }
        }

        function handlePermissionDenial() {
            const permissionScreen = document.getElementById('permission-screen');
            const p = permissionScreen.querySelector('p');
            const btn = permissionScreen.querySelector('button');
            
            p.textContent = '權限已被拒絕。語音同掃描功能將無法使用。請喺瀏覽器設定中允許權限，然後再試一次。';
            btn.textContent = '再試一次';
            btn.onclick = () => showPermissionScreen();
            
            speak({ visual: "權限被拒絕。部分核心功能將無法使用。", spoken: "權限被拒絕。部分核心功能將無法使用。" });
        }

        function initializeApp(wasAlreadyAuthorized = false) {
            document.getElementById('onboarding-screen').classList.remove('active');
            document.getElementById('permission-screen').classList.remove('active');
            
            document.getElementById('app-header').style.opacity = 1;
            document.getElementById('bottom-nav').classList.add('visible');
            
            setScreenContent();
            
            setupTypingIndicator('purchase-input');
            setupTypingIndicator('education-input');

            document.getElementById('purchase-screen').classList.add('active');
            const purchaseButton = document.querySelector("button[onclick*='purchase-screen']");
            if (purchaseButton) {
                navItems.forEach(item => item.classList.remove('active'));
                purchaseButton.classList.add('active');
            }
            
            let welcomeMessage = wasAlreadyAuthorized 
                ? '歡迎返嚟。你喺購買頁面。長按兩秒即可發問商品資訊。'
                : '多謝您嘅授權！你喺購買頁面。長按兩秒即可發問商品資訊。';

            speak({ 
                visual: welcomeMessage.split('。')[1] || welcomeMessage, 
                spoken: welcomeMessage, 
                duration: 6000 
            });
        }
        
        // --- Page Specific Logic ---
        
        // --- Onboarding Logic ---
        const onboardingContainer = document.querySelector('.onboarding-slide-container');
        const nextButtons = document.querySelectorAll('.onboarding-content button');
        const onboardingSlides = document.querySelectorAll('.onboarding-slide');
        const totalSlides = 4;
        let currentSlide = 0;

        const slideInstructions = [
            "歡迎使用。長按屏幕兩秒，就可以隨時用廣東話發出指令。按下下一步按鈕或輕按一下屏幕即可進入下一步",
            "想睇下自己嘅週期？隨時講「週期」，就可以打開您嘅個人日曆。按下下一步按鈕或輕按一下屏幕即可進入下一步",
            "想分析健康狀況？請講「分析」或「掃描」，然後按照語音提示操作。按下下一步按鈕或輕按一下屏幕即可進入下一步",
            "無論係想買嘢定係學新知識，只要講出「購買」或「學習」，我就會幫到您。按下完成按鈕或輕按一下屏幕即可完成教學"
        ];

        function goToNextSlide() {
            if (currentSlide < totalSlides - 1) {
                currentSlide++;
                updateOnboardingView();
            } else {
                startApp();
            }
        }

        function updateOnboardingView() {
            onboardingContainer.style.transform = `translateX(-${currentSlide * (100 / totalSlides)}%)`;
            
            document.querySelectorAll('.progress-dots').forEach((dotsContainer) => {
                dotsContainer.innerHTML = '';
                for (let i = 0; i < totalSlides; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'dot' + (i === currentSlide ? ' active' : '');
                    dotsContainer.appendChild(dot);
                }
            });
            
            speak({ visual: slideInstructions[currentSlide].split('。')[0], spoken: slideInstructions[currentSlide] });
        }
        
        nextButtons.forEach(button => button.addEventListener('click', goToNextSlide));
        onboardingSlides.forEach(slide => slide.addEventListener('click', (e) => {
            if (!e.target.closest('button')) {
                goToNextSlide();
            }
        }));

        function showPermissionScreen() {
            document.getElementById('onboarding-screen').classList.remove('active');
            document.getElementById('permission-screen').classList.add('active');
            speak({ visual: "請授權使用麥克風和相機", spoken: "為咗提供完整功能，我哋需要您授權使用麥克風同相機。輕按一下屏幕同意授權，或按兩下拒絕授權" });
        }

        function startApp() {
            showPermissionScreen();
        }

        function handleChatInput(transcript, screenId) {
            const { inputId, chatContentId } = chatScreenMap[screenId];
            if (inputId) {
                const inputField = document.getElementById(inputId);
                inputField.value = transcript;
                const sendButtonId = screenId === 'purchase-screen' ? 'send-purchase-btn' : 'send-education-btn';
                document.getElementById(sendButtonId).click();
            }
        }
        
        // --- Analysis Page Functions ---
        async function initCamera() {
            let cameraView = document.getElementById('camera-view');
            if (!cameraView) return;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            try {
                const constraints = { video: { facingMode: 'environment' } };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraView.srcObject = stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                speak({ visual: "無法開啟相機，請先授權。", spoken: "無法開啟相機，請先授權。" });
                resetScanView();
            }
        }

        function startScanProcess() {
            document.getElementById('scan-intro-view').classList.add('hidden');
            document.getElementById('scan-camera-view').classList.remove('hidden');
            document.getElementById('scan-results-view').classList.add('hidden');
            initCamera();
            speak({ 
                visual: "請將衛生巾對準鏡頭", 
                spoken: "請將衛生巾對準鏡頭，按兩下屏幕開始掃描，按一下屏幕即可返回" 
            });
        }

        function startScan() {
            let scanOverlay = document.getElementById('scan-overlay');
            if(scanOverlay) scanOverlay.style.display = 'flex';
            speak({ visual: '收到。正在開始掃描分析...', spoken: '收到，正在開始掃描分析' });
            setTimeout(() => {
                if(scanOverlay) scanOverlay.style.display = 'none';
                displayRandomResult();
            }, 3000);
        }
        
        function rescanFromResults() {
            resetScanView(true); // Suppress speech on rescan
            setTimeout(startScanProcess, 50); 
        }

        function displayRandomResult() {
            const analysisData = {
                bright_red: { title: "鮮紅色", status: "正常", statusColor: "text-green-600", borderColor: "border-green-500", summary: "狀況正常。表示正常的經血量較多，且排出速度快。", details: "表示正常的經血量較多，且排出速度快。" },
                dark_red: { title: "深紅色", status: "正常", statusColor: "text-green-600", borderColor: "border-green-500", summary: "狀況正常。表示血液在子宮內停留的時間較久。", details: "表示血液在子宮內停留的時間較久，或是經血量較少。" },
                brown_black: { title: "咖啡色/黑色", status: "需注意", statusColor: "text-yellow-600", borderColor: "border-yellow-500", summary: "狀況需注意。可能表示月經接近尾聲，但如果持續且量多，則可能需要就醫。", details: "表示經血在體內停留較久，經過氧化後顏色變深，也可能表示月經接近尾聲。 偶爾出現咖啡色分泌物是正常的，但如果持續出現且量多，則可能需要就醫。" },
                pink: { title: "粉紅色", status: "需注意", statusColor: "text-yellow-600", borderColor: "border-yellow-500", summary: "狀況需注意。可能表示經血量少，或是雌激素水平較低。", details: "可能表示經血量少，或是雌激素水平較低。" },
                orange_red: { title: "橘紅色", status: "不正常", statusColor: "text-red-600", borderColor: "border-red-500", summary: "狀況不正常。可能係感染所致，建議就醫。", details: "可能表示黃色分泌物混入經血，或可能是感染所致。" },
                gray: { title: "灰色", status: "不正常", statusColor: "text-red-600", borderColor: "border-red-500", summary: "狀況不正常。可能是感染的跡象，應立即就醫。", details: "如果經血呈現灰色，則可能是感染的跡象，應立即就醫。" }
            };

            const keys = Object.keys(analysisData);
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            const result = analysisData[randomKey];
            
            let resultsView = document.getElementById('scan-results-view');
            if(resultsView) {
                resultsView.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4">分析結果</h3>
                    <div class="card analysis-result ${result.borderColor}">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xl font-bold">${result.title}</h4>
                            <span class="font-bold px-3 py-1 rounded-full text-sm ${result.statusColor} bg-opacity-20 ${result.statusColor.replace('text-', 'bg-')}">${result.status}</span>
                        </div>
                        <p class="text-gray-700">${result.details}</p>
                    </div>
                     <button class="w-full mt-4 bg-purple-600 text-white font-bold py-3 px-4 rounded-lg" onclick="rescanFromResults()">重新掃描</button>
                    <button class="w-full mt-2 bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg" onclick="resetScanView()">返回</button>
                `;
                document.getElementById('scan-camera-view').classList.add('hidden');
                resultsView.classList.remove('hidden');
                speak({ visual: `分析完成。結果為${result.title}`, spoken: `分析完成，結果為${result.title}，按一下返回，按兩下重新掃描` });
            }
        }
        
        function resetScanView(silent = false) {
            let introView = document.getElementById('scan-intro-view');
            let cameraView = document.getElementById('scan-camera-view');
            let resultsView = document.getElementById('scan-results-view');
            if (introView && cameraView && resultsView) {
                introView.classList.remove('hidden');
                cameraView.classList.add('hidden');
                resultsView.classList.add('hidden');
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                if (!silent) {
                    speak({ visual: "返回成功", spoken: "返回成功" });
                }
            }
        }

        function readHistory() {
            const historyItems = document.querySelectorAll('#scan-history-card .flex.justify-between');
            if (historyItems.length === 0) {
                speak({ visual: "暫無歷史記錄", spoken: "暫無歷史記錄" });
                return;
            }

            let historyText = "好的，為您讀出歷史記錄。";
            historyItems.forEach(item => {
                const date = item.children[0].textContent;
                const result = item.children[1].textContent;
                historyText += `${date}嘅記錄係，${result}。`;
            });

            speak({ visual: "正在讀出歷史記錄...", spoken: historyText });
        }
        
        // --- Tracker Page Functions ---
        function generateCalendar(year, month, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
            const dayNames = ["日", "一", "二", "三", "四", "五", "六"];
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let calendarHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button class="p-2 rounded-full hover:bg-gray-100" onclick="alert('上個月')">&lt;</button>
                    <h3 class="font-bold text-lg">${year}年 ${monthNames[month]}</h3>
                    <button class="p-2 rounded-full hover:bg-gray-100" onclick="alert('下個月')">&gt;</button>
                </div>
                <div class="calendar">
            `;
            
            dayNames.forEach(day => {
                calendarHTML += `<div class="calendar-header">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                calendarHTML += `<div class="calendar-day empty"></div>`;
            }

            const today = new Date();
            const todayDate = (today.getFullYear() === year && today.getMonth() === month) ? today.getDate() : -1;

            for (let day = 1; day <= daysInMonth; day++) {
                let classes = 'calendar-day';
                // Mock data for September 2025
                if (year === 2025 && month === 8) {
                    if ([9, 10, 11, 12].includes(day)) classes += ' menstruation';
                    else if (day === 26) classes += ' ovulation';
                    else if (day >= 24 && day <= 29) classes += ' fertile';
                    else classes += ' safe';
                } else {
                    classes += ' safe';
                }

                if (day === todayDate) classes += ' today';
                calendarHTML += `<div class="${classes}">${day}</div>`;
            }

            calendarHTML += `</div>`;
            container.innerHTML = calendarHTML;
        }

        function setScreenContent() {
            document.getElementById('purchase-screen').innerHTML = `
                <div class="screen-content" id="purchase-chat-content" style="padding-bottom: 0;">
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-500 mb-1 ml-2">AI 助手</p>
                            <div class="bg-white p-4 rounded-lg inline-block"><p>你好！請問想搵啲咩產品？</p></div>
                        </div>
                        <div class="flex justify-end">
                            <div class="bg-purple-600 text-white p-3 rounded-lg max-w-xs"><p>幫我搵日用、量多嘅衛生巾。</p></div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 mb-1 ml-2">AI 助手</p>
                            <div class="bg-white p-4 rounded-lg">
                                <p class="font-bold mb-2">收到。為您推薦：</p>
                                <div class="border-t pt-2">
                                    <p class="font-semibold text-purple-700">護舒寶 Infinity 液體衛生巾</p>
                                    <p class="text-sm text-gray-600">特點：超強吸收力，無感體驗。適合量多日子。</p>
                                    <p class="text-sm text-gray-600 mt-1">參考價格：HK$35.9 / 10片</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-white border-t border-gray-200">
                    <div class="flex items-center space-x-2">
                        <input id="purchase-input" type="text" class="w-full bg-gray-100 rounded-full py-2 px-4" placeholder="或者喺度輸入...">
                        <button id="send-purchase-btn" class="bg-purple-600 text-white rounded-full p-2" onclick="sendPurchaseMessage()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('analysis-screen').innerHTML = `
                <div class="screen-content">
                    <div id="scan-intro-view">
                        <div class="card text-center">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">經血掃描分析</h3>
                            <p class="text-gray-600 mb-6" id="scan-intro-text">你可以講出「掃描」或「分析」嚟啟動相機。</p>
                            <button class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg" onclick="startScanProcess()">開始掃描</button>
                        </div>
                        <div class="card" id="scan-history-card">
                            <h3 class="font-bold text-lg mb-4">掃描歷史紀錄</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b pb-2">
                                    <span class="text-gray-600">2025年8月10日</span>
                                    <span class="font-semibold text-green-600">深紅色 - 正常</span>
                                </div>
                                <div class="flex justify-between items-center border-b pb-2">
                                    <span class="text-gray-600">2025年7月12日</span>
                                    <span class="font-semibold text-green-600">鮮紅色 - 正常</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">2025年6月15日</span>
                                    <span class="font-semibold text-yellow-600">咖啡色 - 需注意</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="scan-camera-view" class="hidden text-center">
                        <div class="w-full aspect-[3/4] bg-gray-900 rounded-lg overflow-hidden my-6 shadow-lg relative mx-auto max-w-xs">
                            <video id="camera-view" class="w-full h-full object-cover" autoplay playsinline></video>
                            <div id="scan-overlay" class="absolute inset-0 bg-black bg-opacity-50 flex-col items-center justify-center hidden">
                                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-white"></div>
                                <p class="text-white text-xl mt-4">分析中...</p>
                            </div>
                        </div>
                        <button id="start-scan-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg" onclick="startScan()">開始掃描分析</button>
                        <button class="w-full mt-2 bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg" onclick="resetScanView()">返回</button>
                    </div>
                    <div id="scan-results-view" class="hidden"></div>
                </div>`;
            document.getElementById('tracker-screen').innerHTML = `
                <div class="screen-content">
                    <div class="card text-center">
                        <p class="text-gray-600 text-lg">距離下次經期預計仲有</p>
                        <p class="text-7xl font-bold text-purple-600 my-4">15 <span class="text-2xl font-medium text-gray-700">日</span></p>
                        <p class="text-sm text-gray-500">預計日期：2025年9月9日</p>
                    </div>
                    <div class="card">
                        <div id="calendar-container"></div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 mt-4 text-sm">
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-pink-300 mr-2"></span>經期</div>
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-cyan-200 mr-2"></span>易孕期</div>
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-indigo-300 mr-2"></span>排卵日</div>
                            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-emerald-200 mr-2"></span>安全期</div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('education-screen').innerHTML = `
                <div class="screen-content" id="education-chat-content" style="padding-bottom: 0;">
                    <div class="space-y-4">
                        <div class="flex justify-end">
                            <div class="bg-purple-600 text-white p-3 rounded-lg max-w-xs"><p>經痛點算好？</p></div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 mb-1 ml-2">AI 助手</p>
                            <div class="bg-white p-4 rounded-lg border">
                                <p>您可以嘗試用暖水袋敷下腹部，或者飲用溫熱嘅薑茶舒緩。如果情況嚴重，建議諮詢醫生意見。</p>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <div class="bg-purple-600 text-white p-3 rounded-lg max-w-xs"><p>點解月經會唔準？</p></div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 mb-1 ml-2">AI 助手</p>
                            <div class="bg-white p-4 rounded-lg border">
                                <p>月經唔準可能由好多原因引起，例如壓力大、作息唔規律、飲食改變或者荷爾蒙失調等等。如果情況持續，建議您記錄低週期變化，並諮詢醫生。</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-white border-t border-gray-200">
                    <div class="flex items-center space-x-2">
                        <input id="education-input" type="text" class="w-full bg-gray-100 rounded-full py-2 px-4" placeholder="或者喺度輸入...">
                        <button id="send-education-btn" class="bg-purple-600 text-white rounded-full p-2" onclick="sendEducationMessage()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                    </div>
                </div>`;
        
            // Generate calendar for a specific date for consistent demo
            generateCalendar(2025, 8, 'calendar-container'); // September 2025
        }

        function sendMessage(inputId, chatContentId, isPurchase = false) {
            const input = document.getElementById(inputId);
            const message = input.value.trim();
            if (!message) return;

            const chatContentContainer = document.getElementById(chatContentId);
            const chatContent = chatContentContainer.children[0];
            
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'flex justify-end mb-4';
            userMessageDiv.innerHTML = `<div class="bg-purple-600 text-white p-3 rounded-lg max-w-xs"><p>${message}</p></div>`;
            chatContent.appendChild(userMessageDiv);

            input.value = '';
            typingIndicator.classList.remove('visible');
            chatContentContainer.scrollTop = chatContentContainer.scrollHeight;

            setTimeout(() => {
                const aiResponseDiv = document.createElement('div');
                const aiMessage = isPurchase ? `收到。正在為您尋找關於「${message}」商品嘅資料...` : `收到。正在為您尋找關於「${message}」嘅資料...`;
                const aiSpokenMessage = `收到。正在為您尋找關於${message}嘅資料`;

                aiResponseDiv.innerHTML = `
                    <p class="text-sm text-gray-500 mb-1 ml-2">AI 助手</p>
                    <div class="bg-white p-4 rounded-lg inline-block">
                        <p>${aiMessage}</p>
                    </div>`;
                chatContent.appendChild(aiResponseDiv);
                chatContentContainer.scrollTop = chatContentContainer.scrollHeight;
                speak({ visual: aiMessage, spoken: aiSpokenMessage });
            }, 1000);
        }

        function sendPurchaseMessage() {
            sendMessage('purchase-input', 'purchase-chat-content', true);
        }
        function sendEducationMessage() {
            sendMessage('education-input', 'education-chat-content');
        }

        const setupTypingIndicator = (inputId) => {
            const input = document.getElementById(inputId);
            if (!input) return;
            input.addEventListener('input', () => {
                if (input.value.trim() !== '') {
                    typingIndicator.classList.add('visible');
                } else {
                    typingIndicator.classList.remove('visible');
                }
            });
        };

        function unlockAudio() {
            if (window.speechSynthesis.getVoices().length > 0) return;
            const utterance = new SpeechSynthesisUtterance('');
            window.speechSynthesis.speak(utterance);
        }

        window.onload = () => {
            const splashScreen = document.getElementById('splash-screen');
            let startTimeout;
            let flowStarted = false;
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices();
            }

            const startAppFlow = () => {
                if (flowStarted) return;
                flowStarted = true;
                unlockAudio();
                clearTimeout(startTimeout); 
                splashScreen.removeEventListener('click', startAppFlow);
                splashScreen.classList.add('fade-out');
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    checkPermissionsAndStart(); 
                }, 500);
            };

            startTimeout = setTimeout(startAppFlow, 3000); 
            splashScreen.addEventListener('click', startAppFlow);
        };
    </script>
</body>
</html>
